<!doctype html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>HTML5 Platformer</title>

    <script src="//cdn.jsdelivr.net/phaser/2.5.0/phaser.min.js"></script>
</head>
<body>
    <script type="text/javascript">
        window.onload = function () {
            var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
            function preload() {
                game.load.image('platform', 'assets/platform.png');
                game.load.image('ground', 'assets/ground.png');
                game.load.image('goal', 'assets/star.png');
                game.load.spritesheet('bg', 'assets/bg.png', 800, 600);
                game.load.spritesheet('snowflakes', 'assets/snowflakes.png', 17, 17);
                game.load.spritesheet('player1', 'assets/player1.png', 28, 38);
                game.load.spritesheet('player2', 'assets/player2.png', 28, 38);
                //game.load.spritesheet('bad1', 'assets/baddie.png', 32, 32);
            }

            var ledge;
            var ground;

            var scoreTextP1;
            var scoreTextP2;

            var scoreP1 = 0;
            var scoreP2 = 0;

            var isP1LookingLeft = 0;
            var isP2LookingLeft = 1;

            // for snow
            var max = 0;
            var back_emitter;

            // for timer
            var timer;
            var timerText = 0;
            var timerInSeconds = 0;

            function create() {
                game.physics.startSystem(Phaser.Physics.ARCADE);
                //adding background
                bg = game.add.sprite(0, 0, 'bg');
                bg.animations.add('twinkle', [0, 1, 2, 3, 4], 8, true);

                platforms = game.add.group();
                platforms.enableBody = true;

                ground = platforms.create(0, game.world.height - 64, 'ground');
                ground.body.immovable = true;

                ledge = platforms.create(575, 400, 'platform');
                ledge.body.immovable = true;
                ledge = platforms.create(-175, 400, 'platform');
                ledge.body.immovable = true;
                ledge = platforms.create(200, 260, 'platform');
                ledge.body.immovable = true;

                //timer

                timer = game.time.create(false);
                timer.loop(30000, timerChecker, this);
                timer.start();

                //adding object to collect
                stars = game.add.group();
                stars.enableBody = true;

                //spawning the star
                for (var i = 0; i < 5; i++) {
                    var star = stars.create(i * 150 + 100, 300, 'goal');
                }

                //adding player and applying gravity to him
                player = game.add.sprite(50, game.world.height - 900, 'player1');
                player2 = game.add.sprite(718, game.world.height - 900, 'player2');
                //enemy = game.add.sprite(400, game.world.height - 500, 'bad1');
                game.physics.arcade.enable(player);
                game.physics.arcade.enable(player2);
                //game.physics.arcade.enable(enemy);
                //physics properties
                // player.body.bounce.y = 0.2;
                player.body.gravity.y = 300;
                player.body.collideWorldBounds = true;

                // player2.body.bounce.y = 0.2;
                player2.body.gravity.y = 300;
                player2.body.collideWorldBounds = true;

                // enemy.body.bounce.y = 0.2;
                // enemy.body.gravity.y = 300;
                // enemy.body.collideWorldBounds = true;
                //player animation
                player.animations.add('left', [2, 0, 1], 9, true);
                player.animations.add('right', [3, 4, 5], 9, true);
                player.animations.add('standLeft', [2], 1, true);
                player.animations.add('standRight', [3], 1, true);
                //player2 animation
                player2.animations.add('left', [2, 0, 1], 9, true);
                player2.animations.add('right', [3, 4, 5], 9, true);
                player2.animations.add('standLeft', [2], 1, true);
                player2.animations.add('standRight', [3], 1, true);

                //enemy animation
                // enemy.animations.add('left', [0, 1], 10, true);
                // enemy.animations.add('right', [2, 3], 10, true);
                //adding keyboard as input
                cursors = game.input.keyboard.createCursorKeys();
                w = game.input.keyboard.addKey(Phaser.Keyboard.W);
                a = game.input.keyboard.addKey(Phaser.Keyboard.A);
                s = game.input.keyboard.addKey(Phaser.Keyboard.S);
                d = game.input.keyboard.addKey(Phaser.Keyboard.D);

                //adding score text at the top for player 1 and 2

                scoreTextP1 = game.add.text(20, 20, 'Score: 0', { fontSize: '25px', fill: '#FFF' });
                scoreTextP2 = game.add.text(660, 20, 'Score: 0', { fontSize: '25px', fill: '#FFF' });
                timerText = game.add.text(380, 20, timer.duration.toFixed(0) / 1000, { fontSize: '25px', fill: '#FFF' });

                //snow

                back_emitter = game.add.emitter(game.world.centerX, -32, 600);
                back_emitter.makeParticles('snowflakes', [0, 1, 2, 3, 4, 5]);
                back_emitter.maxParticleScale = 0.4;
                back_emitter.minParticleScale = 0.2;
                back_emitter.setYSpeed(20, 100);
                back_emitter.gravity = 0;
                back_emitter.width = game.world.width * 1.5;
                back_emitter.minRotation = 0;
                back_emitter.maxRotation = 20;

                back_emitter.start(false, 14000, 10);

            }
            function update() {
                var hitPlatform = game.physics.arcade.collide(player, platforms);
                var hitPlatform = game.physics.arcade.collide(player2, platforms);
                //var hitPlatform = game.physics.arcade.collide(enemy, platforms);
                player.body.velocity.x = 0;
                player2.body.velocity.x = 0;
                //enemy.body.velocity.x = 0;
                bg.animations.play('twinkle');

                //player input
                if (a.isDown) {
                    player.body.velocity.x = -200;
                    player.animations.play('left');
                    isP1LookingLeft = 1;
                }
                else {
                    if (d.isDown) {
                        player.body.velocity.x = 200;
                        player.animations.play('right');
                        isP1LookingLeft = 0;
                    }
                    else {
                        if (isP1LookingLeft == 1) {
                            player.animations.play('standLeft');
                        }
                        else {
                            player.animations.play('standRight');
                        }
                    }
                }
                if (w.isDown && player.body.touching.down && hitPlatform) {
                    player.body.velocity.y = -300;
                }

                //player2 input
                if (cursors.left.isDown) {
                    player2.body.velocity.x = -200;
                    player2.animations.play('left');
                    isP2LookingLeft = 1;
                }
                else {
                    if (cursors.right.isDown) {
                        player2.body.velocity.x = 200;
                        player2.animations.play('right');
                        isP2LookingLeft = 0;
                    }
                    else {
                        if (isP2LookingLeft == 1) {
                            player2.animations.play('standLeft');
                        }
                        else {
                            player2.animations.play('standRight');
                        }
                    }
                }
                if (cursors.up.isDown && player2.body.touching.down && hitPlatform) {
                    player2.body.velocity.y = -300;
                }


                //what happens when the enemy touches the player
                //            game.physics.arcade.overlap(player, enemy, killplayer, null, this);

                //             function killplayer(player, enemy) {
                //                 player.kill();
                //             }
                //what happens when the player collects a star
                game.physics.arcade.overlap(player, stars, collectP1, null, this);

                game.physics.arcade.overlap(player2, stars, collectP2, null, this);

                timerText.text = timer.duration.toFixed(0) / 1000;

                function collectP1(player, stars) {
                    stars.kill();

                    scoreP1 += 5;
                    scoreTextP1.text = 'Score: ' + scoreP1;
                }
                function collectP2(player2, stars) {
                    stars.kill();

                    scoreP2 += 5;
                    scoreTextP2.text = 'Score: ' + scoreP2;
                }
            }

            function timerChecker() {
                if (scoreP1 > scoreP2) {
                    scoreTextP1.text = 'WINNER';
                    scoreTextP2.text = 'LOSER';
                    player2.kill();
                }
                else if (scoreP1 < scoreP2) {
                    scoreTextP1.text = 'LOSER';
                    scoreTextP2.text = 'WINNER';
                    player.kill();
                }
                else {
                    scoreTextP1 = 'TIE';
                    scoreTextP2 = 'TIE';
                } 
                timer.stop();
            }
        }
    </script>
</body>
</html>
